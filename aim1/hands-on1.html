
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>ハンズオン1 · 利用者視点と開発者視点から理解するウェブサイトの安全性 -セキュリティ・ミニキャンプ in 東京 2024-</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="csrf-overview.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    はじめに
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../pre/">
            
                <a href="../pre/">
            
                    
                    事前課題
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../pre/environment-setting.html">
            
                <a href="../pre/environment-setting.html">
            
                    
                    環境構築
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../pre/http.html">
            
                <a href="../pre/http.html">
            
                    
                    HTTP による通信を触ってみる
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../pre/github-pages.html">
            
                <a href="../pre/github-pages.html">
            
                    
                    GitHub Pages でページをデプロイしてみる
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    利用者として、ウェブサイトの利用を正しく怖がろう
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="vuln-overview.html">
            
                <a href="vuln-overview.html">
            
                    
                    ウェブページ閲覧で生じる可能性のある危険
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="csrf-overview.html">
            
                <a href="csrf-overview.html">
            
                    
                    具体例としての CSRF の説明
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.3" data-path="hands-on1.html">
            
                <a href="hands-on1.html">
            
                    
                    ハンズオン1
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    開発者として、ウェブサイトの開発にあたって適切な対策をしよう
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" >
            
                <span>
            
                    
                    ブラウザという登場人物
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" >
            
                <span>
            
                    
                    ハンズオン2
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" >
            
                <span>
            
                    
                    フレームワークという登場人物
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" >
            
                <span>
            
                    
                    中間総括
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" >
            
                <span>
            
                    
                    サプライチェーンに潜む危険性
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" >
            
                <span>
            
                    
                    ハンズオン3
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    まとめ
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../cheat-sheet.html">
            
                <a href="../cheat-sheet.html">
            
                    
                    チートシート
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >ハンズオン1</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <html><head></head><body><h1 id="ハンズオン１：CSRF_を体験してみよう"><a name="ハンズオン１：CSRF_を体験してみよう" class="plugin-anchor" href="#ハンズオン１：CSRF_を体験してみよう"><i class="fa fa-link" aria-hidden="true"></i></a>ハンズオン１：CSRF を体験してみよう</h1>
<p>環境構築が済んでいない人は、<a href="../pre/environment-setting.html">このページ</a>に従って環境構築をしてください。</p>
<p>この章では、<a href="https://github.com/sasakiy84/csrf-demo" target="_blank">https://github.com/sasakiy84/csrf-demo</a> を利用します。
readme に従ってアプリを起動してください。nodejs か docker-compose の実行環境が必要です。
読み進めていくと、localhost:3000 / 127.0.0.1:4000 へのリンクが出てくると思います。これは、サンプルアプリへのリンクを示しています。localhost:3000 のリンクが本物のアプリで、127.0.0.1:4000 のリンクが攻撃者が作成したアプリのものだと思ってください。</p>
<h2 id="もっとも単純な_CSRF：_GET_リクエストで掲示板への投稿"><a name="もっとも単純な_CSRF：_GET_リクエストで掲示板への投稿" class="plugin-anchor" href="#もっとも単純な_CSRF：_GET_リクエストで掲示板への投稿"><i class="fa fa-link" aria-hidden="true"></i></a>1. もっとも単純な CSRF： GET リクエストで掲示板への投稿</h2>
<p>まずは、ログイン認証がなく、GET を使ったエンドポイントを用いて、最も簡単な CSRF を示します。
なお、今後はローカルマシンでサンプルアプリが起動していることを前提として、実際に挙動を確認するリンクなどを示します。</p>
<h3 id="シナリオとコード"><a name="シナリオとコード" class="plugin-anchor" href="#シナリオとコード"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. シナリオとコード</h3>
<p>以下、理解を助けるために、現実に当てはめたシナリオを提示します。</p>
<blockquote>
<p>あなたは、掲示板サイトを作ることにしました。
機能としては以下の通りです。</p>
<p>ユーザーはログイン認証が不要
ユーザーの識別は IP アドレスで行う
投稿内容は、URL のクエリパラメタとしてクライアントからサーバーに送信される
投稿された内容は、すべて同じ掲示板で表示され、だれでも閲覧できる
CSRF の脆弱性を抜きにしても色々と問題がありますが、あなたは経験不足から問題点に気が付きませんでした。</p>
</blockquote>
<p>その結果として実装されたのが、以下のエンドポイントです。
なお、本質でない機能は簡略化しています。たとえば、投稿された内容は保存などを行っていません。
<a href="https://github.com/sasakiy84/csrf-demo/blob/main/originHandler/1-board.ts" target="_blank">https://github.com/sasakiy84/csrf-demo/blob/main/originHandler/1-board.ts</a></p>
<pre><code class="lang-js"><span class="hljs-comment">// /1-get-board に来た GET リクエストを処理する</span>
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/1-get-board&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// リクエスト送信者の IP アドレスを取得する</span>
  <span class="hljs-keyword">const</span> ip = req.<span class="hljs-property">ip</span>;
  <span class="hljs-comment">// URL クエリパラメタに text という名前で埋め込まれている値を取得する</span>
  <span class="hljs-keyword">const</span> postedText = req.<span class="hljs-property">query</span>.<span class="hljs-property">text</span>;
  <span class="hljs-keyword">if</span> (!postedText) {
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;query: text is required&quot;</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 掲示板に投稿する代わりに、サーバー側のコンソールに表示する</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`user: <span class="hljs-subst">${ip}</span> ::: <span class="hljs-subst">${postedText}</span>`</span>);
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`&lt;p&gt;全体掲示板：今日の投稿&lt;br /&gt;user: <span class="hljs-subst">${ip}</span> ::: <span class="hljs-subst">${postedText}</span>&lt;/p&gt;`</span>);
});
</code></pre>
<p>簡単に処理の内容を説明すると、reqest の情報が入っているreqという変数から IP アドレスと text という URL のクエリパラメタを取り出して、その内容を表示させています。</p>
<p>クエリパラメタについて概要を説明しておきます。
URL は、いくつかの部分に分けることができ、クエリパラメタは path の後の部分をさします。具体的には、?で始まり、以降key1=value1の組み合わせが&amp;で繋がっていきます。
たとえば、<a href="http://example.com/path/to/html.html?key1=value1&amp;key2=value2のような感じです。" target="_blank">http://example.com/path/to/html.html?key1=value1&amp;key2=value2のような感じです。</a>
検索クエリなどをクライアントがサーバーに渡すときに用いられることが多いです。</p>
<h3 id="アプリの正常系"><a name="アプリの正常系" class="plugin-anchor" href="#アプリの正常系"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. アプリの正常系</h3>
<p>サーバーは、クライアントから以下のような URL のリクエストを受け取ります。</p>
<pre><code>http://localhost:3000/1-get-board?text=%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AE%E6%8A%95%E7%A8%BF
</code></pre><p>ここでのクエリパラメタは、text=%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AE%E6%8A%95%E7%A8%BFの部分です。
ちなみに、%E3などの意味不明な文字列は、日本語が変換されたものです。ブラウザの検索窓などにコピペすると、日本語が復元されると思います。</p>
<p>このリンクにアクセスすると、処理が実行され、今回であればはじめての投稿という投稿内容がコンソール画面とクライアントに表示されます。</p>
<h3 id="攻撃シナリオ"><a name="攻撃シナリオ" class="plugin-anchor" href="#攻撃シナリオ"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. 攻撃シナリオ</h3>
<p>では、このアプリにどのような CSRF 脆弱性があるのでしょうか。あるシナリオを想定してみましょう</p>
<blockquote>
<p>あなたがとあるブログを見ていると、以下のようなコメントがありました。</p>
<blockquote>
<p>この記事について、より詳細に書かれた内容が &gt;&gt; <a href="http://localhost:3000/1-get-board?text=%E7%A7%81%E3%81%AF%E5%91%BC%E5%A3%B0%E5%B8%82%E5%BD%B9%E6%89%80%E3%82%92%E7%88%86%E7%A0%B4%E3%81%97%E3%81%BE%E3%81%99" target="_blank">ここ</a> &lt;&lt; にあります</p>
</blockquote>
<p>あなたが興味をもってこのリンクを踏むと、以下の URL にとばされます</p>
<p><a href="http://localhost:3000/1-get-board?text=%E7%A7%81%E3%81%AF%E5%91%BC%E5%A3%B0%E5%B8%82%E5%BD%B9%E6%89%80%E3%82%92%E7%88%86%E7%A0%B4%E3%81%97%E3%81%BE%E3%81%99" target="_blank">http://localhost:3000/1-get-board?text=%E7%A7%81%E3%81%AF%E5%91%BC%E5%A3%B0%E5%B8%82%E5%BD%B9%E6%89%80%E3%82%92%E7%88%86%E7%A0%B4%E3%81%97%E3%81%BE%E3%81%99</a></p>
<p>すると、なんと匿名掲示板サイトに以下の内容が投稿されました</p>
<blockquote>
<p>私は呼声市役所を爆破します</p>
</blockquote>
<p>この投稿は警察に通報され、IP アドレスをもとに投稿者が捜索されました。</p>
</blockquote>
<p>ここで、再び CWE の定義を確認してみましょう。</p>
<p>英語版</p>
<blockquote>
<p>The web application does not, or can not, sufficiently verify whether a well-formed, valid, consistent request was intentionally provided by the user who submitted the request.
<a href="https://jvndb.jvn.jp/ja/cwe/CWE-352.html" target="_blank">https://jvndb.jvn.jp/ja/cwe/CWE-352.html</a></p>
</blockquote>
<p>日本語版</p>
<blockquote>
<p>本脆弱性が存在する Web アプリケーションは、フォーマットに沿った、妥当で一貫性のあるリクエストが、送信したユーザの意図通りに渡されたものかを十分に検証しない、あるいは検証が不可能です。
<a href="https://cwe.mitre.org/data/definitions/352.html" target="_blank">https://cwe.mitre.org/data/definitions/352.html</a></p>
</blockquote>
<p>今回の爆破予告を投稿したリクエストは、ユーザーが意図していないリクエストです。ユーザーはリンクをクリックした時点で、爆破予告を投稿しようという意図は一切なかったはずです。
にもかかわらず、サーバー側ではこのリクエストを正規のものとみなして、掲示板に投稿するという処理を実行してしまいました。このように、ユーザーが意図していないリクエストにより、サーバー側の処理が実行されてしまうのが CSRF 脆弱性です。</p>
<p>演習として、クエリパラメタを調整して、不適切投稿をユーザーにさせてみてください。</p>
<h2 id="ログイン機能をつけても？"><a name="ログイン機能をつけても？" class="plugin-anchor" href="#ログイン機能をつけても？"><i class="fa fa-link" aria-hidden="true"></i></a>2. ログイン機能をつけても？</h2>
<p>前節では、リンクをクリックするだけで、容易に CSRF 攻撃をされてしまうことを説明しました。
では、例えばログイン認証などの機能を入れれば問題なかったのでしょうか？</p>
<p>この節では、一般的にログイン認証として使われている cookie を使った認証機構を、GET リクエストを使って実装します。そして、GET リクエストを使っているとログイン認証があっても、依然として CSRF 脆弱性があることを説明します。</p>
<h3 id="cookie_とはなにか"><a name="cookie_とはなにか" class="plugin-anchor" href="#cookie_とはなにか"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. cookie とはなにか</h3>
<blockquote>
<p>サーバーがユーザーのウェブブラウザーに送信する小さなデータであり、ブラウザーに保存され、その後のリクエストと共に同じサーバーへ返送されます。一般的には、 2 つのリクエストが同じブラウザーから送信されたものであるかを知るために使用されます。
<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies" target="_blank">https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies</a></p>
</blockquote>
<p>cookie は、HTTP ヘッダの一種です。
サーバーからクライアントにレスポンスを返すときに、サーバー側のアプリケーションは必要に応じて、Set-Cookieヘッダをレスポンスに付与します。</p>
<p>Set-Cookieヘッダを含むレスポンスを受け取ったクライアント（基本的にはブラウザ）は、クライアント側の端末に cookie を保存します。cookie は、name=value という形式をもち、文字列として保存されます。</p>
<h3 id="cookie_を使ったセッションの実装"><a name="cookie_を使ったセッションの実装" class="plugin-anchor" href="#cookie_を使ったセッションの実装"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. cookie を使ったセッションの実装</h3>
<h3 id="サンプルアプリの正常系の挙動確認"><a name="サンプルアプリの正常系の挙動確認" class="plugin-anchor" href="#サンプルアプリの正常系の挙動確認"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. サンプルアプリの正常系の挙動確認</h3>
<p>まずは、以下の URL にアクセスして、login requiredという表示がされることを確認してください</p>
<p><a href="http://localhost:3000/2-get-confirm" target="_blank">http://localhost:3000/2-get-confirm</a></p>
<p>次に以下のリンクにアクセスすると、logined!という表示が出ると思います。以下のリンクには、name と password というクエリパラメタが含まれています。</p>
<p><a href="http://localhost:3000/2-get-login?name=wowow&amp;password=whooo!" target="_blank">http://localhost:3000/2-get-login?name=wowow&amp;password=whooo!</a></p>
<p>その後、再度以下のリンクにアクセスしてみると、ログインしていることが確認できると思います</p>
<p><a href="http://localhost:3000/2-get-confirm" target="_blank">http://localhost:3000/2-get-confirm</a></p>
<h3 id="サンプルアプリの正常系のコード確認"><a name="サンプルアプリの正常系のコード確認" class="plugin-anchor" href="#サンプルアプリの正常系のコード確認"><i class="fa fa-link" aria-hidden="true"></i></a>2.4. サンプルアプリの正常系のコード確認</h3>
<p>実装をみながら説明していきます。
/2-get-confirm の URL にアクセスすると、/originHandler/2-password-change.tsファイルの 8 行目にある、以下のような処理が開始されます。</p>
<pre><code class="lang-js"><span class="hljs-comment">// /2-get-login に GET リクエストがきたら、この関数が処理を受け持つ</span>
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/2-get-login&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// name, password の値を URL クエリから取り出す</span>
  <span class="hljs-keyword">const</span> { name, password } = req.<span class="hljs-property">query</span>;
  <span class="hljs-comment">// name, password が存在するかを確かめる</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name !== <span class="hljs-string">&quot;string&quot;</span> || <span class="hljs-keyword">typeof</span> password !== <span class="hljs-string">&quot;string&quot;</span>) {
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;query: name and password is required&quot;</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 正しい name と password かどうかを検証する</span>
  <span class="hljs-keyword">if</span> (users[name] &amp;&amp; users[name].<span class="hljs-property">password</span> === password) {
    <span class="hljs-comment">// ランダムな sessionId を生成する</span>
    <span class="hljs-keyword">const</span> sessionId = crypto.<span class="hljs-title function_">randomUUID</span>();
    <span class="hljs-comment">// sessionId をサーバー側に保存する</span>
    sessionIds[sessionId] = {
      <span class="hljs-attr">userName</span>: name,
    };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`registered sessionId <span class="hljs-subst">${sessionId}</span> for user <span class="hljs-subst">${name}</span>`</span>);
    <span class="hljs-comment">// sessionId をクライアントに保存するために、 Set-Cookie ヘッダを追加する</span>
    res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&quot;sessionId&quot;</span>, sessionId);
    <span class="hljs-comment">// レスポンスを返す</span>
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;logined!&quot;</span>);
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;name or password is incorrect&quot;</span>);
  }
});
</code></pre>
<p>また、usersオブジェクトは、以下のようなデータで初期化されています</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> <span class="hljs-attr">users</span>: <span class="hljs-title class_">Users</span> = {
  <span class="hljs-attr">wowow</span>: {
    <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;whooo!&quot;</span>,
  },
};
</code></pre>
<p>上記の処理が行われた結果、あなたのクライアントに sessionId の cookie が保存されます。実際に保存されたかどうかを見てみましょう。
以下、chrome で cookie を確認します。
logined!が出ている画面で検証ツールを開いてください（右クリックのメニューから「検証」をクリックしてください）
次に、application タブを開き、cookie から、localhost:3000 を選択してください。すると、sessionIdの欄に、生成された sessionId が確認できるでしょう。</p>
<p><img src="img/hands-on1/cookie-dev-tool.png" alt="alt text"></p>
<p>そのまま、検証画面上で network タブを開いてください。
そして、以下のページを再読み込みすると、ネットワークでやりとりされているファイルがみられると思います。</p>
<p><a href="http://localhost:3000/2-get-login?name=wowow&amp;password=whooo!" target="_blank">http://localhost:3000/2-get-login?name=wowow&amp;password=whooo!</a></p>
<p>その中から document の 2-get-login を開いてみましょう。request と response のそれぞれの HTTP ヘッダが確認できると思います。response のなかに、Set-Cookieヘッダがあることを確認しましょう。</p>
<p><img src="img/hands-on1/set-cookie.png" alt="alt text"></p>
<p>また、以下のリンクを踏むと、request に Cookieヘッダが含まれていることが、同様に network タブから確認できます。</p>
<p><a href="http://localhost:3000//2-get-confirm" target="_blank">http://localhost:3000//2-get-confirm</a></p>
<p><img src="img/hands-on1/request-with-cookie.png" alt="alt text"></p>
<h3 id="パスワード変更機能"><a name="パスワード変更機能" class="plugin-anchor" href="#パスワード変更機能"><i class="fa fa-link" aria-hidden="true"></i></a>2.5. パスワード変更機能</h3>
<p>ログインした状態で、以下のリンクにアクセスすると、パスワード変更が可能です。クエリパラメタのnewPasswordの値を好きなものに書き換えてください。
<a href="http://localhost:3000/2-get-password-change?newPassword=yourNewPassword" target="_blank">http://localhost:3000/2-get-password-change?newPassword=yourNewPassword</a></p>
<p>ログインした状態であれば、changePassword関数が実行され、パスワードが変更されるはずです。</p>
<p>実装を確認してみましょう。</p>
<pre><code class="lang-js"><span class="hljs-comment">// 2-get-password-change というパスに GET リクエストがきたら処理する</span>
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/2-get-password-change&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// cookie から sessionId を取り出す</span>
  <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">cookies</span>[<span class="hljs-string">&quot;sessionId&quot;</span>];
  <span class="hljs-comment">// クエリパラメタから newPassword を取り出す</span>
  <span class="hljs-keyword">const</span> newPassword = req.<span class="hljs-property">query</span>.<span class="hljs-property">newPassword</span>;

  <span class="hljs-comment">// sessionId を確認し、ログイン済みかどうかを確かめる</span>
  <span class="hljs-keyword">if</span> (!sessionId || !sessionIds[sessionId]) res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;login required&quot;</span>);
  <span class="hljs-comment">// passward を変更する</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newPassword !== <span class="hljs-string">&quot;string&quot;</span>) res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;newPassword is required&quot;</span>);
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> userName = sessionIds[sessionId].<span class="hljs-property">userName</span>;
    <span class="hljs-title function_">changePassword</span>(userName, newPassword);
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;password changed!&quot;</span>);
  }
});
</code></pre>
<h3 id="CSRF_を試してみる"><a name="CSRF_を試してみる" class="plugin-anchor" href="#CSRF_を試してみる"><i class="fa fa-link" aria-hidden="true"></i></a>2.6. CSRF を試してみる</h3>
<p>以上のような実装をしている場合の CSRF 脆弱性について確認します。
ある日、以下のようなメールが送られてきて、リンクをクリックしたとします。</p>
<blockquote>
<p>おめでとうございます！抽選に当選しました！！以下のリンクから景品を選んでください！！！！
<a href="http://localhost:3000/2-get-password-change?newPassword=evilPassword" target="_blank">当選品選択ページ</a></p>
</blockquote>
<p>このとき、ログインした状態であれば、localhost:3000 に sessionId を含んだ cookie が送信されます。すると、サーバー側は既にログイン済みとして、パスワード変更の処理を実行してしまい、あなたのアカウントのパスポートがevilPasswordに変更されてしまいます。</p>
<p>今回であれば、リンクは次のようなものだったので、パスワードが evilPassward になってしまうということですね。
<a href="http://localhost:3000/2-get-password-change?newPassword=evilPassword" target="_blank">http://localhost:3000/2-get-password-change?newPassword=evilPassword</a></p>
<p>ほかにも、たとえば掲示板サービスの投稿用 API のリンクであれば、不適切な発現を投稿してしまうかもしれません。</p>
<p>このような挙動は、cookie が送信される条件に注目すると理解できます。
cookie を送信するかどうかは、cookie を発行したドメインであれば自動で送信することになっています。逆に言えば、送信元がどのウェブサイトであっても（攻撃者のウェブサイトであっても、悪意のあるリンクによる遷移だとしても）、送信先が一致すれば cookie は送られるということです。
この挙動は、ユーザーの利便性のためには欠かせないものです。もしドメインをまたいだリクエストのときに cookie が送信されないと、ほかページのリンクから遷移するごとに毎回認証が必要になってしまいます。
たとえば、もし twitter へのリンクがこのウェブサイト上にあったとして、リンクをクリックすると twitter の画面にログイン済みの状態で遷移することを期待すると思います。ログイン済みの状態でなければ、いいねなどができないですしね。しかし、異なるドメインのサイトなので、cookie が送信されず、ログイン状態にならないといった事態が起こるでしょう。（これは twitter が cookie でログイン状態を管理していた
場合の話です）</p>
<p>今回であれば、localhost:3000 に紐づけられている cookie が存在したので、localhost:3000 宛てのリクエストを送るときにその cookie を含んだリクエストを作ったということです。</p>
<p>ただし、以上の説明は現在ではウソがあります。後でそこのことを説明します。</p>
<h2 id="_"><a name="_" class="plugin-anchor" href="#_"><i class="fa fa-link" aria-hidden="true"></i></a>3.  </h2>
<div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#ハンズオン１：CSRF_を体験してみよう">ハンズオン１：CSRF を体験してみよう</a></p><li><a href="#もっとも単純な_CSRF：_GET_リクエストで掲示板への投稿">1. もっとも単純な CSRF： GET リクエストで掲示板への投稿</a></li><ul><li><a href="#シナリオとコード">1.1. シナリオとコード</a></li><li><a href="#アプリの正常系">1.2. アプリの正常系</a></li><li><a href="#攻撃シナリオ">1.3. 攻撃シナリオ</a></li></ul><li><a href="#ログイン機能をつけても？">2. ログイン機能をつけても？</a></li><ul><li><a href="#cookie_とはなにか">2.1. cookie とはなにか</a></li><li><a href="#cookie_を使ったセッションの実装">2.2. cookie を使ったセッションの実装</a></li><li><a href="#サンプルアプリの正常系の挙動確認">2.3. サンプルアプリの正常系の挙動確認</a></li><li><a href="#サンプルアプリの正常系のコード確認">2.4. サンプルアプリの正常系のコード確認</a></li><li><a href="#パスワード変更機能">2.5. パスワード変更機能</a></li><li><a href="#CSRF_を試してみる">2.6. CSRF を試してみる</a></li></ul><li><a href="#_">3.  </a></li></ul></div><a href="#もっとも単純な_CSRF：_GET_リクエストで掲示板への投稿" id="goTop"><i class="fa fa-arrow-up"></i></a></body></html>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="csrf-overview.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 具体例としての CSRF の説明">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"ハンズオン1","level":"1.3.3","depth":2,"next":{"title":"開発者として、ウェブサイトの開発にあたって適切な対策をしよう","level":"1.4","depth":1,"ref":"","articles":[{"title":"ブラウザという登場人物","level":"1.4.1","depth":2,"ref":"","articles":[]},{"title":"ハンズオン2","level":"1.4.2","depth":2,"ref":"","articles":[]},{"title":"フレームワークという登場人物","level":"1.4.3","depth":2,"ref":"","articles":[]},{"title":"中間総括","level":"1.4.4","depth":2,"ref":"","articles":[]},{"title":"サプライチェーンに潜む危険性","level":"1.4.5","depth":2,"ref":"","articles":[]},{"title":"ハンズオン3","level":"1.4.6","depth":2,"ref":"","articles":[]}]},"previous":{"title":"具体例としての CSRF の説明","level":"1.3.2","depth":2,"path":"aim1/csrf-overview.md","ref":"aim1/csrf-overview.md","articles":[]},"dir":"ltr"},"config":{"plugins":["navigator","hide-published-with","anchors","hints","@honkit/honkit-plugin-ga"],"root":"./docs/","styles":{"website":"styles/custom.css"},"pluginsConfig":{"search":{},"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"@honkit/honkit-plugin-ga":{},"navigator":{},"ga":{"trackingID":"","anonymizeIP":true},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"introduction.md","glossary":"GLOSSARY.md","summary":"_SUMMARY.md"},"variables":{},"title":"利用者視点と開発者視点から理解するウェブサイトの安全性 -セキュリティ・ミニキャンプ in 東京 2024-","gitbook":"*"},"file":{"path":"aim1/hands-on1.md","mtime":"2024-04-06T15:46:07.280Z","type":"markdown"},"gitbook":{"version":"5.1.4","time":"2024-04-06T15:46:11.926Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../gitbook/@honkit/honkit-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

